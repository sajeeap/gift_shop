<form class="bg0 p-t-75 p-b-85" id="placeorderForm">
  <div class="container">
    <div class="row">
      <div class="col-lg-10 col-xl-7 m-lr-auto m-b-50">
        <div class="row">
          <!-- Delivery Address Section -->
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <h4 class="mtext-109 cl2 p-b-30">Delivery Address</h4>
                <!-- Display Address if Available -->
                <% if (address && address._id) { %>
                  <div class="default-address">
                    <address id="selectedAddress">
                      <!-- This will be updated with the selected address -->
                      <span class="address_name">
                        <%= address.name %>
                      </span><br />
                      <span class="address_type">
                        <%= address.address_type %>
                      </span><br />
                      <span class="zip_code">
                        <%= address.zip_code %>
                      </span><br />
                      <span class="locality">
                        <%= address.locality %>
                      </span><br />
                      <span class="house_name">
                        <%= address.house_name %>
                      </span><br />
                      <span class="area_street">
                        <%= address.area_street %>
                      </span><br />
                      <span class="town">
                        <%= address.town %>
                      </span><br />
                      <span class="state">
                        <%= address.state %>
                      </span><br />
                      <span class="landmark">
                        <%= address.landmark %>
                      </span>
                    </address>
                  </div>
                  <input type="hidden" id="selectedAddressId" name="address" value="<%= address._id %>" />
                  <a href="#" class="btn btn-primary" onclick="openEditModal('<%= address._id %>')">Edit</a>
                  <a href="#" class="btn btn-primary" id="changeAddressButton" data-toggle="modal"
                    data-target="#changeAddressModal">Change</a>
                  <% } else { %>
                    <p>No default address found. Please set a default address.</p>
                    <a href="/user/profile" class="btn btn-primary mt-3">Add New Address +</a>
                    <% } %>
              </div>
            </div>
          </div>

          <!-- Apply Coupon Section -->
          <div class="col-12 mt-3">
            <h5 class="mt-3">Apply Coupon</h5>
            <div class="card mt-3">
              <div class="card-body">
                <div class="flex-w flex-m m-r-20 m-tb-5">
                  <input id="couponCode" class="stext-104 cl2 plh4 size-117 bor13 p-lr-20 m-r-10 m-tb-5" type="text"
                    name="coupon" placeholder="Coupon Code" value="<%= appliedCouponCode || '' %>" />
                  <div id="applyRemoveCouponBtn"
                    class="flex-c-m stext-101 cl2 size-118 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-5">
                    <% if (appliedCouponCode) { %> Remove Coupon <% } else { %>
                        Apply Coupon <% } %>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Coupons Modal -->
          <div class="modal fade" id="couponsModal" tabindex="-1" role="dialog" aria-labelledby="couponsModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="couponsModalLabel">
                    Available Coupons
                  </h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <ul id="couponsList" class="list-group">
                    <% if (coupons.length> 0) { %> <% coupons.forEach(function(coupon) { %>
                        <li class="list-group-item mt-2">
                          <strong>
                            <%= coupon.coupon_code %>
                          </strong><br>
                          <div class="text text-warning">
                            <%= coupon.discount_amount %>% off
                          </div>

                          Min Purchase: <%= coupon.min_purchase %>
                            <br>
                            <a href="#" class="btn btn-primary apply-coupon-btn mt-2"
                              data-coupon-code="<%= coupon.coupon_code %>">
                              Apply
                            </a>
                        </li>
                        <% }) %>
                          <% } else { %>
                            <li class="list-group-item">No available coupons</li>
                            <% } %>
                  </ul>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    Close
                  </button>
                </div>
              </div>
            </div>
          </div>


          <!-- Payment Options Section -->
          <div class="col-12 m-t-20">
            <div class="card mt-3">
              <div class="card-body">
                <h4 class="mtext-109 cl2">Payment Options</h4>
                <div class="m-l-20 m-t-23">
                  <!-- Use Wallet Balance -->
                  <div class="form-check m-t-10">
                    <input class="form-check-input" type="radio" name="paymentoptions" id="payment1" value="Wallet"
                      checked />
                    <label class="form-check-label" for="payment1">Wallet ($<%= walletBalance.toFixed(2) %>)</label>
                    <% if (walletBalance < totalPrice) { %>
                      <a href="#" class="btn bg1 cl0 bor1 mt-2 mb-3" data-bs-toggle="modal"
                        data-bs-target="#addMoneyModal">+ Add Money</a>
                      <% } %>
                  </div>
                  <div class="form-check m-t-10">
                    <input class="form-check-input" type="radio" name="paymentoptions" id="payment2" value="COD" />
                    <label class="form-check-label" for="payment2">COD</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentoptions" id="payment3"
                      value="Razor Pay" />
                    <label class="form-check-label" for="payment3">Razor Pay</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- cart details -->

      <!-- Cart Totals Section -->
      <div class="col-sm-10 col-lg-7 col-xl-5 m-lr-auto m-b-50">
        <div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
          <h4 class="mtext-109 cl2 p-b-30">Cart Totals</h4>

          <div class="flex-w flex-t bor12 p-b-13">
            <div class="size-208">
              <span class="stext-110 cl2">Subtotal:</span>
            </div>
            <div class="size-209">
              <span class="mtext-110 cl2">$<%= totalPrice.toFixed(2) %></span>
            </div>
          </div>

          <!-- Coupon Details -->
          <% if (appliedCouponCode) { %>
            <div class="flex-w flex-t bor12 p-b-13">
              <div class="size-208">
                <span class="stext-110 cl2">Coupon Code:</span>
              </div>
              <div class="size-209">
                <span class="mtext-110 cl2">
                  <%= appliedCouponCode %>
                </span>
              </div>
            </div>
            <div class="flex-w flex-t bor12 p-b-13">
              <div class="size-208">
                <span class="stext-110 cl2">Discount:</span>
              </div>
              <div class="size-209">
                <span class="mtext-110 cl2">-$<%= couponDiscount.toFixed(2) %> (<%= couponDiscountPercentage %>%)</span>
              </div>
            </div>
            <% } %>



              <div class="flex-w flex-t p-t-27 p-b-33">
                <div class="size-208">
                  <span class="mtext-101 cl2">Total:</span>
                </div>
                <div class="size-209 p-t-1">
                  <% const discountedTotal=totalPrice - (couponDiscount || 0); %>
                    <span class="mtext-110 cl2">$<%= discountedTotal.toFixed(2) %></span>
                </div>
              </div>






              <button type="submit" class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer">
                Pay Now
              </button>
        </div>
      </div>




    </div>
  </div>
</form>

<!-- Modal address -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Add/Edit Address</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="address-form" action="/user/add-address" method="POST">
        <div class="modal-body">
          <input type="hidden" name="addressId" id="addressId" />
          <input type="text" name="name" id="name" placeholder="Name" class="form-control mb-2" required />
          <input type="text" name="address_type" id="address_type" placeholder="Address Type" class="form-control mb-2"
            required />
          <input type="text" name="zip_code" id="zip_code" placeholder="Zip Code" class="form-control mb-2" required />
          <input type="text" name="locality" id="locality" placeholder="Locality" class="form-control mb-2" required />
          <input type="text" name="house_name" id="house_name" placeholder="House Name" class="form-control mb-2"
            required />
          <input type="text" name="area_street" id="area_street" placeholder="Area/Street" class="form-control mb-2"
            required />
          <input type="text" name="town" id="town" placeholder="Town" class="form-control mb-2" required />
          <input type="text" name="state" id="state" placeholder="State" class="form-control mb-2" required />
          <input type="text" name="landmark" id="landmark" placeholder="Landmark" class="form-control mb-2" required />
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Close
          </button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- change address modal -->
<div class="modal fade" id="changeAddressModal" tabindex="-1" role="dialog" aria-labelledby="changeAddressModalLabel"
  aria-hidden="true">
  <div class="modal-dialog lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="changeAddressModalLabel">Change Address</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Display Address if Available -->
        <div class="row">
          <% if (addresses && addresses.length> 0) { %>
            <% addresses.forEach(function(address) { %>
              <div class="col-lg-6 mb-3" id="address-<%= address._id %>">
                <div class="card mb-3 mb-lg-0">
                  <div class="card-body">
                    <address>
                      <span class="name">
                        <%= address.name %>
                      </span><br />
                      <span class="address_type">
                        <%= address.address_type %>
                      </span><br />
                      <span class="zip_code">
                        <%= address.zip_code %>
                      </span><br />
                      <span class="locality">
                        <%= address.locality %>
                      </span><br />
                      <span class="house_name">
                        <%= address.house_name %>
                      </span><br />
                      <span class="area_street">
                        <%= address.area_street %>
                      </span><br />
                      <span class="town">
                        <%= address.town %>
                      </span><br />
                      <span class="state">
                        <%= address.state %>
                      </span><br />
                      <span class="landmark">
                        <%= address.landmark %>
                      </span>
                    </address>
                    <div class="mt-2">
                      <button class="btn btn-primary" onclick="selectAddress('<%= address._id %>')">Select</button>

                    </div>
                  </div>
                </div>
              </div>
              <% }); %>
                <% } else { %>
                  <p>No addresses found.</p>
                  <% } %>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- Add Money Modal -->
<div class="modal fade" id="addMoneyModal" tabindex="-1" aria-labelledby="addMoneyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addMoneyModalLabel">Add Money to Wallet</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addMoneyForm">
          <div class="mb-3">
            <label for="amount" class="form-label">Amount (USD)</label>
            <input type="number" class="form-control" id="amount" name="amount"
              value="<%= totalPrice.toFixed(2)-walletBalance.toFixed(2) %>" required />
          </div>
          <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-primary" id="payButton">
              Add Money
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<!-- address form  -->

<script>
  function openEditModal(addressId) {
    const address = document.getElementById("address-" + addressId);
    const name = address.querySelector(".address_name").innerText;
    const addressType = address.querySelector(".address_type").innerText;
    const zipCode = address.querySelector(".zip_code").innerText;
    const locality = address.querySelector(".locality").innerText;
    const houseName = address.querySelector(".house_name").innerText;
    const areaStreet = address.querySelector(".area_street").innerText;
    const town = address.querySelector(".town").innerText;
    const state = address.querySelector(".state").innerText;
    const landmark = address.querySelector(".landmark").innerText;

    document.getElementById("addressId").value = addressId;
    document.getElementById("name").value = name;
    document.getElementById("address_type").value = addressType;
    document.getElementById("zip_code").value = zipCode;
    document.getElementById("locality").value = locality;
    document.getElementById("house_name").value = houseName;
    document.getElementById("area_street").value = areaStreet;
    document.getElementById("town").value = town;
    document.getElementById("state").value = state;
    document.getElementById("landmark").value = landmark;

    $("#exampleModal").modal("show");
  }

  document
    .getElementById("address-form")
    .addEventListener("submit", function (e) {
      e.preventDefault(); // Prevent form submission

      const name = document.getElementById("name").value;
      const addressType = document.getElementById("address_type").value;
      const zipCode = document.getElementById("zip_code").value;
      const locality = document.getElementById("locality").value;
      const houseName = document.getElementById("house_name").value;
      const areaStreet = document.getElementById("area_street").value;
      const town = document.getElementById("town").value;
      const state = document.getElementById("state").value;
      const landmark = document.getElementById("landmark").value;

      const addressId = document.getElementById("addressId").value;

      let url = "/user/add-address";
      let method = "POST";

      if (addressId) {
        url = "/user/edit-address";
        method = "POST";
      }

      // If all validations pass, submit the form using AJAX
      fetch(url, {
        method: method,
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          addressId,
          name,
          addressType,
          zipCode,
          locality,
          houseName,
          areaStreet,
          town,
          state,
          landmark,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            Swal.fire({
              icon: "success",
              title: "Success",
              text: data.message,
            }).then(() => {
              // Optionally redirect or perform other actions after success
              window.location.href = "/user/checkout"; // Redirect to profile page
            });
          } else {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: data.message,
            });
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          Swal.fire({
            icon: "error",
            title: "Server Error",
            text: "An error occurred while processing the address",
          });
        });
    });

  function editAddress(addressId) {
    openEditModal(addressId);
  }

  function selectAddress(addressId) {
    // Get the address details
    const selectedAddress = document.querySelector(`#address-${addressId} address`).innerHTML;

    // Update the checkout page with the selected address
    document.getElementById('selectedAddress').innerHTML = selectedAddress;
    document.getElementById('selectedAddressId').value = addressId;

    // Close the modal
    $('#changeAddressModal').modal('hide');
  }



</script>

<!-- add money pay button -->
<script>
  document.getElementById("payButton").addEventListener("click", function (e) {
    e.preventDefault();

    const amountUSD = parseFloat(document.getElementById("amount").value);
    if (isNaN(amountUSD) || amountUSD <= 0) {
      alert("Please enter a valid amount.");
      return;
    }

    // Example conversion rate

    fetch("/user/add-money", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ amount: amountUSD, currency: "INR" }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (!data || !data.orderId || !data.amount) {
          throw new Error("Invalid server response.");
        }

        var options = {
          key: "<%= process.env.RAZOR_PAY_KEY_ID %>", // Your Razorpay Key ID
          amount: data.amount, // Amount in INR
          currency: "INR",
          order_id: data.orderId,
          name: "Wallet Top-up",
          description: "Add money to wallet",
          handler: function (response) {
            fetch("/user/verify-payment", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                orderId: data.orderId,
                paymentId: response.razorpay_payment_id,
                signature: response.razorpay_signature,
                amount: amountUSD, // Pass amount for wallet update
              }),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  alert("Payment successful!");
                  location.reload(); // Reload to update wallet balance
                } else {
                  alert("Payment verification failed!");
                }
              })
              .catch((error) => {
                console.error("Error verifying payment:", error);
                alert("Failed to verify payment.");
              });
          },
          theme: {
            color: "#3399cc",
          },
        };

        var rzp1 = new Razorpay(options);
        rzp1.open();
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Failed to process payment.");
      });
  });
</script>




<!-- payment -->

<script>
  document.querySelector("#placeorderForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const selectedPaymentMethod = document.querySelector('input[name="paymentoptions"]:checked').value;
    const selectedAddress = document.querySelector('input[name="address"]').value;
    const totalPrice = parseFloat("<%= discountedTotalPrice.toFixed(2) %>");
    const walletBalance = parseFloat("<%= walletBalance.toFixed(2) %>");

    const confirmPayment = await Swal.fire({
      title: 'Confirm Payment',
      text: `You have selected ${selectedPaymentMethod}. Do you want to proceed with the payment?`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Yes, Proceed',
      cancelButtonText: 'Cancel',
    });

    if (confirmPayment.isConfirmed) {
      const response = await fetch('/user/place-order', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          paymentoptions: selectedPaymentMethod,
          totalPrice: totalPrice,
          walletBalance: walletBalance,
          address: selectedAddress,
        }),
      });

      const data = await response.json();

      if (data.success) {
        if (selectedPaymentMethod === "Razor Pay") {
          var options = {
            key: "<%= process.env.RAZOR_PAY_KEY_ID %>",
            amount: totalPrice * 100,
            currency: "INR",
            name: "Order Payment",
            description: "Payment for order",
            handler: function (response) {
              fetch("/user/verify-orderpayment", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  paymentId: response.razorpay_payment_id,
                  orderId: data.orderId,
                }),
              })
                .then((response) => response.json())
                .then((verifyData) => {
                  if (verifyData.success) {
                    window.location.href = `/user/order-success/${data.orderId}`;
                  } else {
                    Swal.fire({
                      icon: "error",
                      title: "Payment Verification Failed",
                      text: "Please try again.",
                    });
                  }
                })
                .catch((error) => {
                  console.error("Error verifying payment:", error);
                  Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: "Failed to verify payment.",
                  });
                });
            },
            

            theme: {
              color: "#3399cc",
            },
            modal: {
              ondismiss: function () {
                window.location.href = `/user/order-success/${data.orderId}`;
              },
            },
          };

          var rzp1 = new Razorpay(options);
          rzp1.open();
        } else if (selectedPaymentMethod === "COD") {
          window.location.href = `/user/order-success/${data.orderId}`;
        } else if (selectedPaymentMethod === "Wallet") {
          if (walletBalance >= totalPrice) {
            Swal.fire({
              icon: "success",
              title: "Payment Successful",
              text: "Your order has been placed successfully.",
              showConfirmButton: false,
              timer: 1500,
            }).then(() => {
              window.location.href = `/user/order-success/${data.orderId}`;
            });
          } else {
            Swal.fire({
              icon: "error",
              title: "Insufficient Wallet Balance",
              text: "You have two options:",
              showCancelButton: true,
              confirmButtonText: "Add Money",
              cancelButtonText: "Use Wallet & Pay Rest",
            }).then((result) => {
              if (result.isConfirmed) {
                $("#addMoneyModal").modal("show");
              } else {
                const remainingAmount = totalPrice - walletBalance;

                Swal.fire({
                  title: "Select Additional Payment Method",
                  input: 'select',
                  inputOptions: {
                    'Razor Pay': 'Razor Pay',
                    'COD': 'Cash on Delivery',
                  },
                  inputPlaceholder: 'Select payment method',
                  showCancelButton: true,
                  confirmButtonText: "Proceed",
                  cancelButtonText: "Cancel",
                }).then((result) => {
                  if (result.isConfirmed) {
                    const additionalPaymentMethod = result.value;
                    if (additionalPaymentMethod) {
                      if (additionalPaymentMethod === "Razor Pay") {
                        var options = {
                          key: "<%= process.env.RAZOR_PAY_KEY_ID %>",
                          amount: remainingAmount * 100,
                          currency: "INR",
                          name: "Order Payment",
                          description: "Payment for order",
                          handler: function (response) {
                            fetch("/user/verify-orderpayment", {
                              method: "POST",
                              headers: {
                                "Content-Type": "application/json",
                              },
                              body: JSON.stringify({
                                paymentId: response.razorpay_payment_id,
                                orderId: data.orderId,
                              }),
                            })
                              .then((response) => response.json())
                              .then((verifyData) => {
                                if (verifyData.success) {
                                  Swal.fire({
                                    icon: "success",
                                    title: "Payment Verified",
                                    text: "Proceeding with order submission.",
                                    showConfirmButton: false,
                                    timer: 1500,
                                  }).then(() => {
                                    window.location.href = `/user/order-success/${data.orderId}`;
                                  });
                                } else {
                                  Swal.fire({
                                    icon: "error",
                                    title: "Payment Verification Failed",
                                    text: "Please try again.",
                                  });
                                }
                              })
                              .catch((error) => {
                                console.error("Error verifying payment:", error);
                                Swal.fire({
                                  icon: "error",
                                  title: "Error",
                                  text: "Failed to verify payment.",
                                });
                              });
                          },
                          theme: {
                            color: "#3399cc",
                          },
                        };

                        var rzp1 = new Razorpay(options);
                        rzp1.open();
                      } else if (additionalPaymentMethod === "COD") {
                        if (remainingAmount > 1000) {
                          Swal.fire({
                            icon: "error",
                            title: "COD Not Available",
                            text: "Cash on Delivery is not available for orders above ₹1000. Please choose another payment method.",
                          });
                        } else {
                          Swal.fire({
                            icon: "info",
                            title: "Cash on Delivery",
                            text: "Proceeding with COD payment.",
                            showConfirmButton: false,
                            timer: 1500,
                          }).then(() => {
                            window.location.href = `/user/order-success/${data.orderId}`;
                          });
                        }
                      }
                    }
                  }
                });
              }
            });
          }
        }
      } else {
        Swal.fire({
          title: "Purchase Failed",
          text: data.message || "There was an issue with your order. Please try again.",
          icon: "error",
        });
      }
    }
  });

</script>

<!-- <script>
  document.querySelector("#placeorderForm").addEventListener("submit", async function (e) {
  e.preventDefault(); // Prevent the form from submitting immediately

  const selectedPaymentMethod = document.querySelector('input[name="paymentoptions"]:checked').value;
  const selectedAddress = document.querySelector('input[name="address"]').value;
  const totalPrice = parseFloat("<%= discountedTotalPrice.toFixed(2) %>");
  const walletBalance = parseFloat("<%= walletBalance.toFixed(2) %>");

  const response = await fetch('/user/place-order', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      paymentoptions: selectedPaymentMethod,
      totalPrice: totalPrice,
      walletBalance: walletBalance,
      address: selectedAddress,
    }),
  });

  const data = await response.json();

  if (data.success) {
    if (selectedPaymentMethod === "Razor Pay") {
      // Handle Razorpay logic
      var options = {
        key: "<%= process.env.RAZOR_PAY_KEY_ID %>", 
        amount: totalPrice * 100, 
        currency: "INR",
        name: "Order Payment",
        description: "Payment for order",
        handler: function (response) {
          fetch("/user/verify-orderpayment", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              paymentId: response.razorpay_payment_id,
              orderId: data.orderId,
            }),
          })
            .then((response) => response.json())
            .then((verifyData) => {
              if (verifyData.success) {
                window.location.href = `/user/order-success/${data.orderId}`;
              } else {
                Swal.fire({
                  icon: "error",
                  title: "Payment Verification Failed",
                  text: "Please try again.",
                });
              }
            })
            .catch((error) => {
              console.error("Error verifying payment:", error);
              Swal.fire({
                icon: "error",
                title: "Error",
                text: "Failed to verify payment.",
              });
            });
        },
        theme: {
          color: "#3399cc",
        },
        modal: {
          ondismiss: function () {
            window.location.href = `/user/order-success/${data.orderId}`;
          },
        },
      };

      var rzp1 = new Razorpay(options);
      rzp1.open();
    } else if (selectedPaymentMethod === "COD") {
      window.location.href = `/user/order-success/${data.orderId}`;
    } else if (selectedPaymentMethod === "Wallet") {
      if (walletBalance >= totalPrice) {
        // Wallet balance is sufficient
        Swal.fire({
          icon: "success",
          title: "Payment Successful",
          text: "Your order has been placed successfully.",
          showConfirmButton: false,
          timer: 1500,
        }).then(() => {
          window.location.href = `/user/order-success/${data.orderId}`;
        });
      } else {
        // Wallet balance is insufficient, ask for alternative payment method
        Swal.fire({
          icon: "error",
          title: "Insufficient Wallet Balance",
          text: "You have two options:",
          showCancelButton: true,
          confirmButtonText: "Add Money",
          cancelButtonText: "Use Wallet & Pay Rest",
        }).then((result) => {
          if (result.isConfirmed) {
            // Open the Add Money modal
            $("#addMoneyModal").modal("show");
          } else {
            // Calculate remaining amount after using wallet balance
            const remainingAmount = totalPrice - walletBalance;

            Swal.fire({
              title: "Select Additional Payment Method",
              input: 'select',
              inputOptions: {
                'Razor Pay': 'Razor Pay',
                'COD': 'Cash on Delivery',
              },
              inputPlaceholder: 'Select payment method',
              showCancelButton: true,
              confirmButtonText: "Proceed",
              cancelButtonText: "Cancel",
            }).then((result) => {
              if (result.isConfirmed) {
                const additionalPaymentMethod = result.value;
                if (additionalPaymentMethod) {
                  // Handle the partial wallet payment and other method logic here
                  if (additionalPaymentMethod === "Razor Pay") {
                    var options = {
                      key: "<%= process.env.RAZOR_PAY_KEY_ID %>",
                      amount: remainingAmount * 100, 
                      currency: "INR",
                      name: "Order Payment",
                      description: "Payment for order",
                      handler: function (response) {
                        fetch("/user/verify-orderpayment", {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                          },
                          body: JSON.stringify({
                            paymentId: response.razorpay_payment_id,
                          }),
                        })
                          .then((response) => response.json())
                          .then((verifyData) => {
                            if (verifyData.success) {
                              Swal.fire({
                                icon: "success",
                                title: "Payment Verified",
                                text: "Proceeding with order submission.",
                                showConfirmButton: false,
                                timer: 1500,
                              }).then(() => {
                                window.location.href = `/user/order-success/${data.orderId}`;
                              });
                            } else {
                              Swal.fire({
                                icon: "error",
                                title: "Payment Verification Failed",
                                text: "Please try again.",
                              });
                            }
                          })
                          .catch((error) => {
                            console.error("Error verifying payment:", error);
                            Swal.fire({
                              icon: "error",
                              title: "Error",
                              text: "Failed to verify payment.",
                            });
                          });
                      },
                      theme: {
                        color: "#3399cc",
                      },
                    };

                    var rzp1 = new Razorpay(options);
                    rzp1.open();
                  } else if (additionalPaymentMethod === "COD") {
                    if (remainingAmount > 1000) {
                      Swal.fire({
                        icon: "error",
                        title: "COD Not Available",
                        text: "Cash on Delivery is not available for orders above ₹1000. Please choose another payment method.",
                      });
                    } else {
                      Swal.fire({
                        icon: "info",
                        title: "Cash on Delivery",
                        text: "Proceeding with COD payment.",
                        showConfirmButton: false,
                        timer: 1500,
                      }).then(() => {
                        window.location.href = `/user/order-success/${data.orderId}`;
                      });
                    }
                  }
                }
              }
            });
          }
        });
      }
    }
  } else {
    Swal.fire({
      title: "Purchase Failed",
      text: data.message || "There was an issue with your order. Please try again.",
      icon: "error",
    });
  }
});

</script> -->

<!-- <script>
  document.querySelector("#placeorderForm").addEventListener("submit", async  function (e) {
    
    e.preventDefault(); // Prevent the form from submitting immediately

    const selectedPaymentMethod = document.querySelector('input[name="paymentoptions"]:checked').value;
    const selectedAddress = document.querySelector('input[name="address"]').value;
    const totalPrice = parseFloat("<%= discountedTotalPrice.toFixed(2) %>");
    const walletBalance = parseFloat("<%= walletBalance.toFixed(2) %>");

    
    const response = await fetch('/user/place-order', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          paymentoptions: selectedPaymentMethod,
          totalPrice: totalPrice,
          walletBalance: walletBalance,
          address: selectedAddress
        })
    });

    const data = await response.json();

    if (data.success) {
          if (selectedPaymentMethod === "Razor Pay") {
            var options = {
              key: "<%= process.env.RAZOR_PAY_KEY_ID %>", // Your Razorpay Key ID
              amount: totalPrice * 100, // Amount in cents
              currency: "INR",
              name: "Order Payment",
              description: "Payment for order",
              
              handler: function (response) {

                fetch("/user/verify-orderpayment", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    paymentId: response.razorpay_payment_id,
                    orderId: data.orderId
                  }),
                })
                  .then((response) => response.json())
                  .then((verifyData) => {
                    if (verifyData.success) {
                      window.location.href = `/user/order-success/${data.orderId}`;
                    } else {
                      Swal.fire({
                        icon: "error",
                        title: "Payment Verification Failed",
                        text: "Please try again.",
                      });
                    }
                  })
                  .catch((error) => {
                    console.error("Error verifying payment:", error);
                    Swal.fire({
                      icon: "error",
                      title: "Error",
                      text: "Failed to verify payment.",
                    });
                  });
              },
              theme: {
                color: "#3399cc",
              },
              "modal": {
                "ondismiss": function(){
                  window.location.href = `/user/order-success/${data.orderId}`;
                }
              }
            };

            var rzp1 = new Razorpay(options);
            rzp1.open();
          } else if (selectedPaymentMethod === "COD") {
            // Handle COD success
            window.location.href = `/user/order-success/${data.orderId}`;
          } else if (selectedPaymentMethod === "Wallet"){

            if (walletBalance < totalPrice) {
        Swal.fire({
          icon: "error",
          title: "Insufficient Wallet Balance",
          text: "You have two options:",
          showCancelButton: true,
          confirmButtonText: "Add Money",
          cancelButtonText: "Use Wallet & Pay Rest",
        }).then((result) => {
          if (result.isConfirmed) {
            // Open the Add Money modal
            $("#addMoneyModal").modal("show");
          } else {
            // Calculate remaining amount after using wallet balance
            const remainingAmount = totalPrice - walletBalance;

            Swal.fire({
              title: "Select Additional Payment Method",
              input: 'select',
              inputOptions: {
                'Razor Pay': 'Razor Pay',
                'COD': 'Cash on Delivery',
              },
              inputPlaceholder: 'Select payment method',
              showCancelButton: true,
              confirmButtonText: "Proceed",
              cancelButtonText: "Cancel",
            }).then((result) => {
              if (result.isConfirmed) {
                const additionalPaymentMethod = result.value;
                if (additionalPaymentMethod) {
                  // Handle the partial wallet payment and other method logic here
                  if (additionalPaymentMethod === "Razor Pay") {
                    // Trigger Razorpay UI
                    var options = {
                      key: "<%= process.env.RAZOR_PAY_KEY_ID %>", // Your Razorpay Key ID
                      amount: remainingAmount * 100, // Amount in cents
                      currency: "INR",
                      name: "Order Payment",
                      description: "Payment for order",
                      handler: function (response) {
                        fetch("/user/verify-orderpayment", {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                          },
                          body: JSON.stringify({
                            paymentId: response.razorpay_payment_id,
                          }),
                        })
                          .then((response) => response.json())
                          .then((data) => {
                            if (data.success) {
                              Swal.fire({
                                icon: "success",
                                title: "Payment Verified",
                                text: "Proceeding with order submission.",
                                showConfirmButton: false,
                                timer: 1500,
                              }).then(() => {
                                document.querySelector("form").submit(); // Submit the form after Razorpay payment is verified
                              });
                            } else {
                              Swal.fire({
                                icon: "error",
                                title: "Payment Verification Failed",
                                text: "Please try again.",
                              });
                            }
                          })
                          .catch((error) => {
                            console.error("Error verifying payment:", error);
                            Swal.fire({
                              icon: "error",
                              title: "Error",
                              text: "Failed to verify payment.",
                            });
                          });
                      },
                      theme: {
                        color: "#3399cc",
                      },
                    };

                    var rzp1 = new Razorpay(options);
                    rzp1.open();
                  } else if (additionalPaymentMethod === "COD") {
                    if (remainingAmount > 1000) {
                      Swal.fire({
                        icon: "error",
                        title: "COD Not Available",
                        text: "Cash on Delivery is not available for orders above $1000. Please choose another payment method.",
                      });
                    } else {
                      Swal.fire({
                        icon: "info",
                        title: "Cash on Delivery",
                        text: "Proceeding with COD payment.",
                        showConfirmButton: false,
                        timer: 1500,
                      }).then(() => {
                        document.querySelector("form").submit(); // Submit the form for COD
                      });
                    }
                  }
                }
              }
            });
          }
        });
      } else {
        Swal.fire({
          title: "Confirm Payment",
          text: "Your wallet balance is sufficient. Do you want to proceed with the payment?",
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "Yes, Proceed",
          cancelButtonText: "Cancel",
        }).then((result) => {
          if (result.isConfirmed) {
            Swal.fire({
              icon: "success",
              title: "Payment Successful",
              text: "Proceeding with payment.",
              showConfirmButton: false,
              timer: 1500,
            }).then(() => {
              document.querySelector("form").submit(); // Submit the form
            });
          }
        });
      }



            
          }
    } else {
      // Show a purchase failed message
      Swal.fire({
        title: 'Purchase Failed',
        text: data.message || 'There was an issue with your order. Please try again.',
        icon: 'error'
      });
    }


    });

    
</script> -->






<!-- coupon -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const applyRemoveCouponBtn = document.getElementById("applyRemoveCouponBtn");
    const couponCodeInput = document.getElementById("couponCode");

    applyRemoveCouponBtn.addEventListener("click", function () {
      if (couponCodeInput.value) {
        swal({
          title: "Are you sure?",
          text: "Do you want to remove the coupon code?",
          icon: "warning",
          buttons: true,
          dangerMode: true,
        }).then((willDelete) => {
          if (willDelete) {
            fetch("/user/remove-coupon", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  swal("Success", data.message, "success").then(() => {
                    couponCodeInput.value = "";
                    applyRemoveCouponBtn.textContent = "Apply Coupon";
                    applyRemoveCouponBtn.setAttribute("data-toggle", "modal");
                    applyRemoveCouponBtn.setAttribute("data-target", "#couponsModal");
                  });
                } else {
                  swal("Error", data.message, "error");
                }
              })
              .catch((error) => {
                console.error("Error removing coupon:", error);
                swal("Error", "An error occurred while removing the coupon.", "error");
              });
          }
        });
      } else {
        $("#couponsModal").modal("show");
      }
    });

    document.querySelectorAll(".apply-coupon-btn").forEach((button) => {
      button.addEventListener("click", function () {
        const couponCode = this.getAttribute("data-coupon-code");
        fetch("/user/apply-coupon", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ coupon_code: couponCode }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              swal("Success", "Coupon applied successfully", "success").then(() => {
                location.reload();
              });
            } else {
              swal("Error", data.message, "error");
            }
          })
          .catch((error) => {
            console.error("Error applying coupon:", error);
            swal("Error", "An error occurred while applying the coupon.", "error");
          });
      });
    });
  });

</script>

<script>
  $(document).ready(function () {
    $('#couponsModal').modal({
      backdrop: 'static',
      keyboard: false
    });
  });
</script>